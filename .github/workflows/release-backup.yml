name: Master Backup

on:
  push:
    branches:
      - master

jobs:
  create-backup:
    name: Create backup branch
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create backup branch
        run: |
          # 현재 날짜와 시간으로 백업 브랜치 이름 생성
          current_date=$(date +"%Y%m%d")
          current_time=$(date +"%H%M")
          backup_branch="backup-${current_date}-${current_time}"

          # 이미 존재하는지 확인 (같은 시간대에 생성된 경우)
          if git ls-remote --heads origin $backup_branch | grep $backup_branch; then
            echo "Backup branch $backup_branch already exists, adding timestamp..."
            backup_branch="backup-${current_date}-${current_time}-$(date +"%S")"
          fi

          # 백업 브랜치 생성
          git checkout -b $backup_branch

          # 백업 정보를 커밋 메시지에 포함
          git commit --allow-empty -m "Backup created for master merge: ${{ github.event.head_commit.message }}"

          # 백업 브랜치 푸시
          git push origin $backup_branch

          echo "✅ Backup branch created: $backup_branch"
          echo "📅 Date: $(date +"%Y-%m-%d %H:%M:%S")"
          echo "📤 Commit: ${{ github.event.head_commit.message }}"
          echo "💾 This branch contains the exact state of master at this point"
