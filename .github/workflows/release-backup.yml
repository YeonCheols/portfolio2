name: Create Release Backup

on:
  release:
    types: [published]

jobs:
  create-release-backup:
    name: Create backup branch for release
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create release backup branch
        id: create-backup
        run: |
          # ë¦´ë¦¬ì¦ˆ íƒœê·¸ë¡œ ì²´í¬ì•„ì›ƒ
          git checkout ${{ github.event.release.tag_name }}

          # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ìœ¼ë¡œ ë°±ì—… ë¸Œëœì¹˜ ì´ë¦„ ìƒì„± (ì˜ˆ: backup-20241201-1430)
          current_date=$(date +"%Y%m%d")
          current_time=$(date +"%H%M")
          backup_branch="backup-${current_date}-${current_time}"

          # ë¦´ë¦¬ì¦ˆ ì •ë³´ë¥¼ í¬í•¨í•œ ì„¤ëª… ì¶”ê°€
          release_info="Release: ${{ github.event.release.tag_name }} - ${{ github.event.release.name }}"

          # ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ê°™ì€ ì‹œê°„ëŒ€ì— ìƒì„±ëœ ê²½ìš°)
          if git ls-remote --heads origin $backup_branch | grep $backup_branch; then
            echo "Backup branch $backup_branch already exists, adding timestamp..."
            backup_branch="backup-${current_date}-${current_time}-$(date +"%S")"
          fi

          # ë°±ì—… ë¸Œëœì¹˜ ìƒì„±
          git checkout -b $backup_branch

          # ë¦´ë¦¬ì¦ˆ ì •ë³´ë¥¼ ì»¤ë°‹ ë©”ì‹œì§€ì— í¬í•¨
          git commit --allow-empty -m "Backup created for $release_info"

          # ë°±ì—… ë¸Œëœì¹˜ í‘¸ì‹œ
          git push origin $backup_branch

          echo "Created backup branch: $backup_branch"
          echo "backup_branch=$backup_branch" >> $GITHUB_OUTPUT
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Comment on release
        if: steps.create-backup.outputs.created == 'true'
        run: |
          backup_branch="${{ steps.create-backup.outputs.backup_branch }}"
          echo "âœ… Backup branch created: \`$backup_branch\`"
          echo "ğŸ“… Date: $(date +"%Y-%m-%d %H:%M:%S")"
          echo "ğŸ·ï¸  Release: ${{ github.event.release.tag_name }} - ${{ github.event.release.name }}"
          echo "ğŸ’¾ This branch contains the exact state of the code at this release"
          echo "ğŸ”„ You can use this branch to restore the code to this specific point in time"

      - name: Skip message
        if: steps.create-backup.outputs.created == 'false'
        run: |
          echo "â„¹ï¸  Backup branch already exists for this release, skipping creation."
