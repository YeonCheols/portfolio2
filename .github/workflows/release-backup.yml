name: Master Backup

on:
  push:
    branches:
      - master

jobs:
  create-backup:
    name: Create backup branch
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create backup branch
        run: |
          # í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ìœ¼ë¡œ ë°±ì—… ë¸Œëœì¹˜ ì´ë¦„ ìƒì„±
          current_date=$(date +"%Y%m%d")
          current_time=$(date +"%H%M")
          backup_branch="backup-${current_date}-${current_time}"

          # ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ê°™ì€ ì‹œê°„ëŒ€ì— ìƒì„±ëœ ê²½ìš°)
          if git ls-remote --heads origin $backup_branch | grep $backup_branch; then
            echo "Backup branch $backup_branch already exists, adding timestamp..."
            backup_branch="backup-${current_date}-${current_time}-$(date +"%S")"
          fi

          # ë°±ì—… ë¸Œëœì¹˜ ìƒì„±
          git checkout -b $backup_branch

          # ë°±ì—… ì •ë³´ë¥¼ ì»¤ë°‹ ë©”ì‹œì§€ì— í¬í•¨
          git commit --allow-empty -m "Backup created for master merge: ${{ github.event.head_commit.message }}"

          # ë°±ì—… ë¸Œëœì¹˜ í‘¸ì‹œ
          git push origin $backup_branch

          echo "âœ… Backup branch created: $backup_branch"
          echo "ğŸ“… Date: $(date +"%Y-%m-%d %H:%M:%S")"
          echo "ğŸ“¤ Commit: ${{ github.event.head_commit.message }}"
          echo "ğŸ’¾ This branch contains the exact state of master at this point"
